(function () {
    'use strict';

    const TRANSLATIONS = {
        en: {
            btnExport: "Export",
            btnStop: "Stop Scanning",
            btnProcessing: "Processing...",
            btnFailed: "Failed",
            btnSuccess: "Success!",
            btnError: "Error",
            statusStarting: "Starting export...",
            statusScanning: "Scanning...",
            statusStop: "Stopping...",
            statusReset: "Resetting scroll position...",
            statusStep1: "Step 1/3: Canvas Content...",
            statusStep2: "Step 2/3: Dialog Content (Scrolling)...",
            statusStep3: "Step 3/3: Merging & Exporting...",
            statusProcessing: (count) => `Processing Data (${count})...`,
            statusNoCanvas: "No Canvas content found.",
            statusNoDialog: "No chat content collected.",
            statusSuccess: (item) => `Export Success: ${item}`,
            statusSuccessWithImages: (item, count) => `Export Success: ${item} (Images: ${count})`,
            statusSuccessWithImageWarning: (item, msg) => `Export Success: ${item} (Image export issue: ${msg})`,
            statusError: (msg) => `Error: ${msg}`,
            statusDownloadingImages: (count) => `Downloading ${count} generated images...`,
            statusImagesDownloadFailed: (msg) => `Image export skipped: ${msg}`,
            logStartingExport: (type, format) => `Starting export.. Type: ${type}, Format: ${format}`,
            statusFormatChanged: "Export format changed",
            btnToggleOpen: "<",
            btnToggleClose: ">",
            logSelectorsUpdated: "Gemini Export: Updated selectors",
            logExtractingCanvas: "Extracting Canvas content...",
            logCanvasExtracted: (count) => `Canvas content extraction complete. Found ${count} items.`,
            txtCombinedHeader: "Gemini Combined Export (Dialog + Canvas)",
            txtDialogSection: "=== Dialog Content ===",
            txtUser: "--- User ---",
            txtAIThought: "--- AI Thought Chain ---",
            txtAIResponse: "--- AI Response ---",
            txtCanvasSection: "=== Canvas Content ===",
            txtCodeBlock: (index, lang) => `--- Code Block ${index} (${lang}) ---`,
            txtTextBlock: (index) => `--- Text Block ${index} ---`,
            txtFullContent: "--- Full Content ---",
            mdHeaderCanvas: (projectName) => `# ${projectName} Canvas Content Export`,
            mdExportTime: (ts) => `Export Time: ${ts}`,
            mdContentBlock: (idx) => `### Content Block ${idx}`,
            mdCodeBlock: (lang) => `**Code Block** (Language: ${lang}):`,
            mdTextBlock: "**Text Content**:",
            mdFullContent: "**Full Content**:",
            mdHeaderCombined: (projectName) => `# ${projectName} Combined Export`,
            mdTurn: (idx) => `### Turn ${idx}`,
            mdUser: "**User**:",
            mdAIThought: "AI Thought Chain",
            mdAIResponse: "**AI Response**:",
            statusWarnNoData: "Warning: Turns found but no data extracted. Check selectors.",
            statusScrolling: (count, max, collected) => `Scrolling ${count}/${max}... Collected ${collected} items...`,
            logFindingScroller: "Starting auto-scroll...",
            statusScrollError: "Error (Scroll): Scroller not found",
            statusScrollNotFoundAlert: "Could not find scrollable area.",
            statusScrollCompleteBottom: "Scroll complete (Bottom reached).",
            statusScrollCompleteTop: "Scroll complete (Returned to top).",
            statusScrollManualStop: (count) => `Scroll stopped manually (Scrolled ${count} times).`,
            statusScrollMaxAttempts: (max) => `Scroll stopped: Max attempts reached (${max}).`,
            txtHeaderScroll: "Gemini Chat History (Scroll Export)",
            txtHeaderSDK: "Gemini Chat History (SDK)",
            txtIncompleteTurn: "--- Turn (Incomplete) ---",
            txtThoughtIncomplete: "Thought (Incomplete):",
            txtResponseIncomplete: "Response (Incomplete):",
            mdHeaderScroll: (projectName, context) => `# ${projectName} Chat Export (${context})`,
            logGeneratingFile: (count) => `Generating file from ${count} items...`,
            logUICreated: "UI Created",
            anchorTitle: "Thread",
            anchorEmpty: "No messages yet",
            anchorUserShort: "Q",
            anchorModelShort: "A",
            anchorUserFallback: "User message",
            anchorModelFallback: "Model response",
            anchorExpand: "Expand message anchors",
            anchorCollapse: "Collapse message anchors",
            anchorJumpTo: (index) => `Jump to message ${index}`
        },
        zh: {
            btnExport: "导出",
            btnStop: "停止扫描",
            btnProcessing: "处理中...",
            btnFailed: "失败",
            btnSuccess: "成功!",
            btnError: "错误",
            statusStarting: "开始导出...",
            statusScanning: "扫描中...",
            statusStop: "正在停止...",
            statusReset: "重置滚动位置...",
            statusStep1: "步骤 1/3: 提取 Canvas 内容...",
            statusStep2: "步骤 2/3: 滚动获取对话内容...",
            statusStep3: "步骤 3/3: 合并数据并导出...",
            statusProcessing: (count) => `处理数据 (${count})...`,
            statusNoCanvas: "未找到 Canvas 内容。",
            statusNoDialog: "未收集到对话内容。",
            statusSuccess: (item) => `导出成功: ${item}`,
            statusSuccessWithImages: (item, count) => `导出成功: ${item}（图片 ${count} 张）`,
            statusSuccessWithImageWarning: (item, msg) => `导出成功: ${item}（图片导出异常: ${msg}）`,
            statusError: (msg) => `错误: ${msg}`,
            statusDownloadingImages: (count) => `正在下载 ${count} 张生成图片...`,
            statusImagesDownloadFailed: (msg) => `图片导出已跳过: ${msg}`,
            logStartingExport: (type, format) => `开始导出.. 类型: ${type}, 格式: ${format}`,
            statusFormatChanged: "导出格式已切换",
            btnToggleOpen: "<",
            btnToggleClose: ">",
            logSelectorsUpdated: "Gemini Export: 选择器已更新",
            logExtractingCanvas: "开始提取 Canvas 内容...",
            logCanvasExtracted: (count) => `Canvas 内容提取完成，共找到 ${count} 个内容块（已去重）`,
            txtCombinedHeader: "Gemini 组合导出 (对话 + Canvas)",
            txtDialogSection: "=== 对话内容 ===",
            txtUser: "--- 用户 ---",
            txtAIThought: "--- AI 思维链 ---",
            txtAIResponse: "--- AI 回答 ---",
            txtCanvasSection: "=== Canvas 内容 ===",
            txtCodeBlock: (index, lang) => `--- 代码块 ${index} (${lang}) ---`,
            txtTextBlock: (index) => `--- 文本内容 ${index} ---`,
            txtFullContent: "--- 完整内容 ---",
            mdHeaderCanvas: (projectName) => `# ${projectName} Canvas 内容导出`,
            mdExportTime: (ts) => `导出时间：${ts}`,
            mdContentBlock: (idx) => `### 内容块 ${idx}`,
            mdCodeBlock: (lang) => `**代码块** (语言: ${lang}):`,
            mdTextBlock: "**文本内容**:",
            mdFullContent: "**完整内容**:",
            mdHeaderCombined: (projectName) => `# ${projectName} 组合导出`,
            mdTurn: (idx) => `### 回合 ${idx}`,
            mdUser: "**用户**:",
            mdAIThought: "AI 思维链",
            mdAIResponse: "**AI 回答**:",
            statusWarnNoData: "警告: 发现聊天回合但未能提取数据，请检查选择器。",
            statusScrolling: (count, max, collected) => `滚动 ${count}/${max}... 已收集 ${collected} 条记录...`,
            logFindingScroller: "启动自动滚动...",
            statusScrollError: "错误 (滚动): 找不到滚动区域",
            statusScrollNotFoundAlert: "未能找到聊天记录的滚动区域。",
            statusScrollCompleteBottom: "滚动完成 (疑似触底)。",
            statusScrollCompleteTop: "滚动完成 (返回顶部)。",
            statusScrollManualStop: (count) => `滚动已手动停止 (已滚动 ${count} 次)。`,
            statusScrollMaxAttempts: (max) => `滚动停止: 已达到最大尝试次数 (${max})。`,
            txtHeaderScroll: "Gemini 聊天记录 (滚动采集)",
            txtHeaderSDK: "Gemini 对话记录 (SDK 代码)",
            txtIncompleteTurn: "--- 回合 (内容提取不完整或失败) ---",
            txtThoughtIncomplete: "思维链(可能不全):",
            txtResponseIncomplete: "回答(可能不全):",
            mdHeaderScroll: (projectName, context) => `# ${projectName} 对话导出 (${context})`,
            logGeneratingFile: (count) => `正在处理 ${count} 条记录并生成文件...`,
            logUICreated: "UI 已创建",
            anchorTitle: "对话锚点",
            anchorEmpty: "暂无消息",
            anchorUserShort: "问",
            anchorModelShort: "答",
            anchorUserFallback: "用户消息",
            anchorModelFallback: "模型回复",
            anchorExpand: "展开消息锚点",
            anchorCollapse: "收起消息锚点",
            anchorJumpTo: (index) => `跳转到第 ${index} 条消息`
        }
    };

    function resolveLanguage(language) {
        return String(language || navigator.language || 'en').startsWith('zh') ? 'zh' : 'en';
    }

    function getTranslations(options = {}) {
        const language = resolveLanguage(options.language);
        return TRANSLATIONS[language] || TRANSLATIONS.en;
    }

    window.GeminiExportI18n = {
        getTranslations,
        resolveLanguage
    };
})();
